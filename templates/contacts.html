{% extends "base/base.html" %}
{% load static phone_filters %}

{% block title %}Контакты | {{ company_info.name|default:"Вымпел-45" }}{% endblock %}

{% block description %}Контакты {{ company_info.name|default:"Вымпел-45" }} - адрес, телефон, email. Свяжитесь с нами для получения консультации по противопожарным металлоизделиям.{% endblock %}

{% block extra_css %}
<style>
    .contact-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,245,240,0.95) 100%);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 107, 0, 0.1);
    }
    
    .form-floating {
        position: relative;
    }
    
    .form-floating label {
        position: absolute;
        left: 1rem;
        top: 1rem;
        pointer-events: none;
        transition: all 0.3s ease;
        color: #6b7280;
        font-weight: 500;
    }
    
    .form-floating input:focus + label,
    .form-floating input:not(:placeholder-shown) + label,
    .form-floating textarea:focus + label,
    .form-floating textarea:not(:placeholder-shown) + label {
        top: -0.5rem;
        left: 0.75rem;
        font-size: 0.75rem;
        color: #ff6b00;
        background: white;
        padding: 0 0.25rem;
    }
    
    .contact-item {
        transition: all 0.3s ease;
        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,245,240,0.9) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 107, 0, 0.1);
    }
    
    .contact-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 35px rgba(255, 107, 0, 0.15);
        border-color: rgba(255, 107, 0, 0.3);
    }
    
    .fire-input {
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(255, 107, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    .fire-input:focus {
        border-color: #ff6b00;
        box-shadow: 0 0 0 4px rgba(255, 107, 0, 0.1);
        background: white;
    }
    
    .steel-input {
        background: rgba(112, 128, 144, 0.05);
        border: 2px solid rgba(112, 128, 144, 0.2);
        transition: all 0.3s ease;
    }
    
    .steel-input:focus {
        border-color: #708090;
        box-shadow: 0 0 0 4px rgba(112, 128, 144, 0.1);
        background: white;
    }

    .address-card {
        background: linear-gradient(135deg, #ff6b00 0%, #dc2626 100%);
        transition: all 0.4s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .address-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.6s ease;
    }

    .address-card:hover::before {
        left: 100%;
    }

    .address-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 25px 50px rgba(255, 107, 0, 0.3);
    }

    .address-icon {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    /* Новые стили для улучшенной карты */
    .enhanced-map-container {
        position: relative;
        border-radius: 24px;
        overflow: hidden;
        background: linear-gradient(135deg, #ff6b00 0%, #dc2626 100%);
        padding: 4px;
        box-shadow: 0 25px 50px rgba(255, 107, 0, 0.2);
        z-index: 10;
    }

    .map-wrapper {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        position: relative;
    }

    .map-controls {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .map-control-btn {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 107, 0, 0.2);
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 44px;
        min-height: 44px;
    }

    .map-control-btn:hover {
        background: rgba(255, 107, 0, 0.95);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(255, 107, 0, 0.3);
    }

    .map-control-btn.active {
        background: #ff6b00;
        color: white;
    }

    .map-info-panel {
        position: absolute;
        bottom: 15px;
        left: 15px;
        right: 15px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 107, 0, 0.2);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transform: translateY(100%);
        transition: transform 0.4s ease;
    }

    .map-info-panel.show {
        transform: translateY(0);
    }

    .coordinate-display {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .coordinate-display.show {
        opacity: 1;
    }

    .map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 999;
        color: #ff6b00;
        text-align: center;
    }

    .pulse-marker {
        animation: pulse-ring 1.5s ease-out infinite;
    }

    @keyframes pulse-ring {
        0% {
            transform: scale(0.33);
            opacity: 1;
        }
        80%, 100% {
            transform: scale(2.4);
            opacity: 0;
        }
    }

    /* Адаптивность для мобильных устройств */
    @media (max-width: 768px) {
        .enhanced-map-container {
            margin: 0 -1rem;
            border-radius: 16px;
            z-index: 5;
        }
        
        .map-controls {
            top: 10px;
            right: 10px;
            gap: 6px;
        }
        
        .map-control-btn {
            min-width: 40px;
            min-height: 40px;
            padding: 10px;
        }
        
        .map-info-panel {
            bottom: 10px;
            left: 10px;
            right: 10px;
            padding: 16px;
        }
    }

    /* Увеличиваем высоту на больших экранах */
    @media (min-width: 1024px) {
        #leaflet-map {
            height: 600px !important;
            min-height: 600px !important;
        }
    }

    /* Скрываем атрибуцию Leaflet */
    .leaflet-control-attribution {
        display: none !important;
    }

    /* Убираем белую полосу */
    .leaflet-container {
        background: transparent !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="relative bg-gradient-to-br from-red-700 via-orange-600 to-red-700 py-20 pt-28 overflow-hidden">
    <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23ff6b00" fill-opacity="0.1"%3E%3Ccircle cx="30" cy="30" r="4"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')] opacity-50"></div>
    
    <div class="relative z-10 max-w-7xl mx-auto px-6 text-center">
        <h1 class="text-4xl md:text-6xl font-black text-white mb-6">
            Свяжитесь с нами
        </h1>
        <p class="text-xl text-orange-100 max-w-2xl mx-auto mb-8">
            Готовы ответить на любые вопросы и предоставить профессиональную консультацию от экспертов по пожарной безопасности
        </p>
        
        <!-- Quick Contact Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center max-w-lg mx-auto">
            {% if company_info.phone %}
            <a href="tel:{{ company_info.phone|format_phone }}" 
               class="flex-1 inline-flex items-center justify-center gap-2 px-6 py-4 bg-white text-red-700 font-bold rounded-xl hover:bg-orange-50 transition-all duration-300 shadow-xl hover:shadow-2xl hover:scale-105">
                <svg class="w-5 h-5 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                </svg>
                Позвонить сейчас
            </a>
            {% endif %}
            
            {% if company_info.email %}
            <a href="mailto:{{ company_info.email }}" 
               class="flex-1 inline-flex items-center justify-center gap-2 px-6 py-4 bg-white/10 backdrop-blur-sm text-white font-bold rounded-xl hover:bg-white/20 transition-all duration-300 border border-white/20 hover:border-white/40">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                </svg>
                Написать email
            </a>
            {% endif %}
        </div>
    </div>
</section>

<!-- Contact Information -->
<section class="py-16 bg-gradient-to-br from-slate-50 to-orange-50">
    <div class="max-w-7xl mx-auto px-6">
        <div class="grid lg:grid-cols-3 gap-8">
            
            <!-- Contact Details -->
            <div class="lg:col-span-1 space-y-6">
                <div>
                    <h2 class="text-3xl font-black text-red-700 mb-6">
                        Наши контакты
                    </h2>
                    <p class="text-gray-600 mb-8">
                        Мы всегда готовы помочь вам с выбором противопожарного оборудования и ответить на все ваши вопросы.
                    </p>
                </div>
                
                <!-- Contact Items -->
                <div class="space-y-4">
                    {% if company_info.phone %}
                    <div class="contact-item p-6 rounded-2xl shadow-lg">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-red-700 mb-1">Телефон</h3>
                                <a href="tel:{{ company_info.phone }}" class="text-gray-700 hover:text-orange-600 transition-colors text-lg font-semibold">
                                    {{ company_info.phone |format_phone}}
                                </a>
                                <p class="text-sm text-gray-500 mt-1">Звонки принимаем в рабочее время</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if company_info.email %}
                    <div class="contact-item p-6 rounded-2xl shadow-lg">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-red-700 mb-1">Email</h3>
                                <a href="mailto:{{ company_info.email }}" class="text-gray-700 hover:text-orange-600 transition-colors font-semibold">
                                    {{ company_info.email }}
                                </a>
                                <p class="text-sm text-gray-500 mt-1">Ответим в течение 2 часов</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if company_info.address %}
                    <div class="contact-item p-6 rounded-2xl shadow-lg">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-red-700 mb-1">Адрес</h3>
                                <p class="text-gray-700 font-medium">{{ company_info.address }}</p>
                                <p class="text-sm text-gray-500 mt-1">Производство и офис продаж</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if company_info.working_hours %}
                    <div class="contact-item p-6 rounded-2xl shadow-lg">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-red-700 mb-1">Режим работы</h3>
                                <p class="text-gray-700 font-medium">{{ company_info.working_hours }}</p>
                                <p class="text-sm text-gray-500 mt-1">По московскому времени</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Contact Form -->
            <div class="lg:col-span-2">
                <div class="contact-card p-8 rounded-3xl shadow-lg">
                    <h2 class="text-3xl font-black text-red-700 mb-6">
                        Оставьте заявку
                    </h2>
                    <p class="text-gray-600 mb-8">
                        Заполните форму, и наш специалист свяжется с вами в ближайшее время для обсуждения деталей заказа и предоставления индивидуального предложения.
                    </p>
                    
                    <form method="POST" x-data="contactForm()" @submit.prevent="submitForm()" class="space-y-6">
                        {% csrf_token %}
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- Name Field -->
                            <div class="form-floating">
                                <input type="text" 
                                       id="name" 
                                       name="name" 
                                       x-model="form.name"
                                       placeholder=" "
                                       required
                                       class="w-full px-4 py-4 fire-input rounded-xl focus:outline-none transition-all duration-300">
                                <label for="name">Ваше имя *</label>
                            </div>
                            
                            <!-- Phone Field с маской -->
                            <div class="form-floating">
                                <input type="tel" 
                                       id="phone" 
                                       name="phone" 
                                       x-model="form.phone"
                                       placeholder=" "
                                       required
                                       oninput="formatPhone(this)"
                                       class="w-full px-4 py-4 fire-input rounded-xl focus:outline-none transition-all duration-300">
                                <label for="phone">Телефон *</label>
                            </div>
                        </div>
                        
                        <!-- Email Field -->
                        <div class="form-floating">
                            <input type="email" 
                                   id="email" 
                                   name="email" 
                                   x-model="form.email"
                                   placeholder=" "
                                   class="w-full px-4 py-4 steel-input rounded-xl focus:outline-none transition-all duration-300">
                            <label for="email">Email</label>
                        </div>
                        
                        <!-- Message Field -->
                        <div class="form-floating">
                            <textarea id="message" 
                                      name="message" 
                                      x-model="form.message"
                                      placeholder=" "
                                      rows="4"
                                      class="w-full px-4 py-4 steel-input rounded-xl focus:outline-none transition-all duration-300 resize-none"></textarea>
                            <label for="message">Сообщение</label>
                        </div>
                        
                        <!-- Consent Checkbox -->
                        <div class="flex items-start gap-3">
                            <input type="checkbox" 
                                   id="consent" 
                                   name="consent" 
                                   x-model="form.consent"
                                   required
                                   class="mt-1 w-5 h-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                            <label for="consent" class="text-sm text-gray-600 leading-relaxed">
                                Я согласен на <a href="#" class="text-orange-600 hover:underline font-semibold">обработку персональных данных</a> 
                                и получение информационных сообщений
                            </label>
                        </div>
                        
                        <!-- Submit Button -->
                        <button type="submit" 
                                :disabled="loading"
                                :class="{ 'opacity-50 cursor-not-allowed': loading }"
                                class="w-full px-8 py-4 bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold rounded-xl hover:from-red-600 hover:to-red-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-[1.02] disabled:hover:scale-100">
                            <span x-show="!loading" class="flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                </svg>
                                Отправить заявку
                            </span>
                            <span x-show="loading" class="flex items-center justify-center gap-2">
                                <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Отправка...
                            </span>
                        </button>
                        
                        <!-- Success/Error Messages -->
                        <div x-show="message" x-transition 
                             :class="{ 'bg-green-50 border-green-200 text-green-800': messageType === 'success', 'bg-red-50 border-red-200 text-red-800': messageType === 'error' }"
                             class="p-4 rounded-xl border" style="display: none;">
                            <p x-text="message" class="font-medium"></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Map or Address Section -->
{% if company_info.address %}
<section class="py-16 bg-gradient-to-br from-orange-50 to-slate-50">
    <div class="max-w-7xl mx-auto px-6">
        <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-black text-red-700 mb-4">
                Как нас найти
            </h2>
            <p class="text-gray-600 max-w-2xl mx-auto">
                Наше производство и офис продаж находятся в удобном месте. Приезжайте к нам для личной консультации!
            </p>
        </div>

        {% if company_info.latitude and company_info.longtitude %}
        <!-- Enhanced Interactive Map -->
        <div class="enhanced-map-container">
            <div class="map-wrapper">
                <!-- Loading indicator -->
                <div id="map-loading" class="map-loading">
                    <div class="w-12 h-12 border-4 border-orange-200 border-t-orange-600 rounded-full animate-spin mx-auto mb-2"></div>
                    <p class="text-sm font-medium">Загрузка карты...</p>
                </div>

                <!-- Coordinate display -->
                <div id="coordinate-display" class="coordinate-display">
                    <div id="coords-text"></div>
                </div>

                <!-- Custom controls -->
                <div class="map-controls">
                    <div class="map-control-btn" id="locate-btn" title="Моё местоположение">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    
                    <div class="map-control-btn" id="info-btn" title="Информация">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                    </div>

                    <div class="map-control-btn" id="route-btn" title="Построить маршрут">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- Map container -->
                <div id="leaflet-map"
                     class="w-full opacity-0 transition-opacity duration-700"
                     style="height: 500px; min-height: 500px;">
                </div>

                <!-- Info panel -->
                <div id="map-info-panel" class="map-info-panel">
                    <div class="flex items-start gap-4">
                        <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center flex-shrink-0">
                            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-red-700 mb-2">{{ company_info.name|default:"Наша компания" }}</h3>
                            <p class="text-gray-700 mb-2">{{ company_info.address }}</p>
                            <p class="text-sm text-gray-500 mb-3">📍 Производство и офис продаж</p>
                            
                            <div class="flex flex-wrap gap-2">
                                <button onclick="openYandexMapsCoords(currentLat, currentLng)" 
                                        class="inline-flex items-center gap-1 px-3 py-1 bg-yellow-100 text-yellow-800 rounded-lg text-sm font-medium hover:bg-yellow-200 transition-colors">
                                    🗺️ Яндекс.Карты
                                </button>
                                <button onclick="openGoogleMaps(currentLat, currentLng)" 
                                        class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm font-medium hover:bg-blue-200 transition-colors">
                                    🌍 Google Maps
                                </button>
                                {% if company_info.phone %}
                                <a href="tel:{{ company_info.phone }}" 
                                   class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-800 rounded-lg text-sm font-medium hover:bg-green-200 transition-colors">
                                    📞 Позвонить
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        <button id="close-info" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Address Card with Yandex Maps Link -->
        <div class="contact-card rounded-3xl shadow-lg overflow-hidden">
            <div class="address-card p-12 rounded-3xl text-center text-white relative overflow-hidden"
                 onclick="openYandexMaps('{{ company_info.address|escapejs }}')">
                <div class="relative z-10">
                    <div class="address-icon w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-black mb-4">Наш адрес</h3>
                    <p class="text-xl font-semibold mb-2 text-orange-100">{{ company_info.address }}</p>
                    <p class="text-orange-200 mb-6">Производство и офис продаж</p>
                    
                    <div class="inline-flex items-center gap-3 px-6 py-3 bg-white/20 backdrop-blur-sm rounded-xl border border-white/30 hover:bg-white/30 transition-all duration-300">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                        <span class="font-bold">Открыть в Яндекс Картах</span>
                    </div>
                    
                    <p class="text-sm text-orange-200 mt-4 opacity-80">Нажмите для построения маршрута</p>
                </div>
                
                <!-- Decorative elements -->
                <div class="absolute top-6 right-6 w-16 h-16 bg-white/10 rounded-full animate-pulse"></div>
                <div class="absolute bottom-6 left-6 w-12 h-12 bg-white/10 rounded-full animate-pulse delay-300"></div>
                <div class="absolute top-1/2 right-12 w-8 h-8 bg-white/10 rounded-full animate-pulse delay-700"></div>
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endif %}

<!-- FAQ Section -->
<section class="py-16 bg-white">
    <div class="max-w-4xl mx-auto px-6">
        <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-black text-red-700 mb-4">
                Часто задаваемые вопросы
            </h2>
            <p class="text-gray-600">
                Ответы на популярные вопросы о нашей продукции и услугах
            </p>
        </div>
        
        <div x-data="{ openFaq: null }" class="space-y-4">
            <!-- FAQ Item 1 -->
            <div class="border border-orange-200 rounded-xl overflow-hidden contact-item">
                <button @click="openFaq = openFaq === 1 ? null : 1" 
                        class="w-full px-6 py-4 text-left flex items-center justify-between hover:bg-orange-50 transition-colors">
                    <span class="font-semibold text-red-700">Какие сертификаты имеет ваша продукция?</span>
                    <svg :class="{ 'rotate-180': openFaq === 1 }" class="w-5 h-5 text-orange-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div x-show="openFaq === 1" x-transition class="px-6 pb-4" style="display: none;">
                    <p class="text-gray-600">Вся наша продукция имеет сертификаты соответствия ГОСТ и ТР ЕАЭС. Сертификаты пожарной безопасности выданы аккредитованными испытательными лабораториями.</p>
                </div>
            </div>
            
            <!-- FAQ Item 2 -->
            <div class="border border-orange-200 rounded-xl overflow-hidden contact-item">
                <button @click="openFaq = openFaq === 2 ? null : 2" 
                        class="w-full px-6 py-4 text-left flex items-center justify-between hover:bg-orange-50 transition-colors">
                    <span class="font-semibold text-red-700">Какие сроки изготовления заказа?</span>
                    <svg :class="{ 'rotate-180': openFaq === 2 }" class="w-5 h-5 text-orange-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div x-show="openFaq === 2" x-transition class="px-6 pb-4" style="display: none;">
                    <p class="text-gray-600">Стандартные изделия изготавливаем за 5-10 рабочих дней. Нестандартные размеры - 15-25 рабочих дней. Точные сроки зависят от сложности и объема заказа.</p>
                </div>
            </div>
            
            <!-- FAQ Item 3 -->
            <div class="border border-orange-200 rounded-xl overflow-hidden contact-item">
                <button @click="openFaq = openFaq === 3 ? null : 3" 
                        class="w-full px-6 py-4 text-left flex items-center justify-between hover:bg-orange-50 transition-colors">
                    <span class="font-semibold text-red-700">Осуществляете ли вы доставку по регионам?</span>
                    <svg :class="{ 'rotate-180': openFaq === 3 }" class="w-5 h-5 text-orange-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div x-show="openFaq === 3" x-transition class="px-6 pb-4" style="display: none;">
                    <p class="text-gray-600">Да, мы осуществляем доставку по всей территории Российской Федерации. Доставка производится автотранспортом или через транспортные компании.</p>
                </div>
            </div>
            
            <!-- FAQ Item 4 -->
            <div class="border border-orange-200 rounded-xl overflow-hidden contact-item">
                <button @click="openFaq = openFaq === 4 ? null : 4" 
                        class="w-full px-6 py-4 text-left flex items-center justify-between hover:bg-orange-50 transition-colors">
                    <span class="font-semibold text-red-700">Предоставляете ли вы гарантию на продукцию?</span>
                    <svg :class="{ 'rotate-180': openFaq === 4 }" class="w-5 h-5 text-orange-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div x-show="openFaq === 4" x-transition class="px-6 pb-4" style="display: none;">
                    <p class="text-gray-600">На всю нашу продукцию предоставляется гарантия. Гарантия распространяется на качество изготовления и соответствие техническим характеристикам.</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map, marker, currentLat, currentLng;
    
    document.addEventListener("DOMContentLoaded", function () {
        var latStr = "{{ company_info.latitude|default:'' }}";
        var lngStr = "{{ company_info.longtitude|default:'' }}";
        var address = "{{ company_info.address|default:'Адрес не указан'|escapejs }}";
        var companyName = "{{ company_info.name|default:'Компания'|escapejs }}";
        
        var lat = parseFloat(latStr.replace(',', '.'));
        var lng = parseFloat(lngStr.replace(',', '.'));
        
        currentLat = lat;
        currentLng = lng;
        
        console.log('Координаты:', lat, lng);
        
        if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
            initializeMap(lat, lng, address, companyName);
        } else {
            console.error('Invalid coordinates provided for map. Lat:', latStr, 'Lng:', lngStr);
            document.getElementById('leaflet-map').style.display = 'none';
            document.getElementById('map-loading').innerHTML = '<p class="text-red-600">Ошибка загрузки координат</p>';
        }
    });
    
    function initializeMap(lat, lng, address, companyName) {
        map = L.map('leaflet-map', {
            center: [lat, lng],
            zoom: 17,
            zoomControl: false,
            attributionControl: false
        });
        
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);
        
        L.control.scale({
            position: 'bottomleft',
            metric: true,
            imperial: false
        }).addTo(map);
        
        var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        });
        
        osmLayer.addTo(map);
        
        var customIcon = L.divIcon({
            className: 'custom-marker',
            html: `
                <div style="position: relative;">
                    <div class="pulse-marker" style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        width: 30px;
                        height: 30px;
                        background: rgba(255, 107, 0, 0.3);
                        border-radius: 50%;
                        transform: translate(-50%, -50%);
                    "></div>
                    <svg width="40" height="40" viewBox="0 0 24 24" style="position: relative; z-index: 2;">
                        <path fill="#ff6b00" stroke="#fff" stroke-width="2" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                        <circle fill="#fff" cx="12" cy="9" r="3"/>
                    </svg>
                </div>
            `,
            iconSize: [40, 40],
            iconAnchor: [20, 40]
        });
        
        marker = L.marker([lat, lng], {icon: customIcon}).addTo(map);
        
        var popupContent = `
            <div style="min-width: 250px; text-align: center;">
                <h3 style="color: #dc2626; font-weight: bold; margin: 0 0 8px 0; font-size: 18px;">
                    ${companyName}
                </h3>
                <p style="margin: 8px 0; color: #374151; font-size: 14px;">
                    ${address}
                </p>
                <p style="color: #6b7280; font-size: 12px; margin: 8px 0 12px 0;">
                    📍 Производство и офис продаж
                </p>
                <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="openYandexMapsCoords(${lat}, ${lng})" 
                            style="background: #ffeb3b; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer;">
                        Яндекс.Карты
                    </button>
                    <button onclick="openGoogleMaps(${lat}, ${lng})" 
                            style="background: #4285f4; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer;">
                        Google Maps
                    </button>
                </div>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        
        map.on('mousemove', function(e) {
            updateCoordinateDisplay(e.latlng.lat, e.latlng.lng);
        });
        
        map.on('mouseout', function() {
            hideCoordinateDisplay();
        });
        
        map.on('click', function(e) {
            showCoordinateDisplay();
            updateCoordinateDisplay(e.latlng.lat, e.latlng.lng);
        });
        
        setupMapControls(lat, lng, address);
        
        setTimeout(function() {
            document.getElementById('map-loading').style.display = 'none';
            var mapElement = document.getElementById('leaflet-map');
            mapElement.classList.remove('opacity-0');
            mapElement.classList.add('opacity-100');
            
            setTimeout(() => marker.openPopup(), 500);
        }, 1000);
        
        map.scrollWheelZoom.disable();
        map.on('click', function() {
            map.scrollWheelZoom.enable();
            setTimeout(() => map.scrollWheelZoom.disable(), 3000);
        });
    }
    
    function setupMapControls(lat, lng, address) {
        document.getElementById('locate-btn').addEventListener('click', function() {
            if (navigator.geolocation) {
                this.classList.add('active');
                navigator.geolocation.getCurrentPosition((position) => {
                    var userLat = position.coords.latitude;
                    var userLng = position.coords.longitude;
                    
                    var userIcon = L.divIcon({
                        className: 'user-marker',
                        html: `<div style="width: 16px; height: 16px; background: #4285f4; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    });
                    
                    L.marker([userLat, userLng], {icon: userIcon})
                        .addTo(map)
                        .bindPopup('📍 Ваше местоположение');
                    
                    var group = new L.featureGroup([marker, L.marker([userLat, userLng])]);
                    map.fitBounds(group.getBounds().pad(0.1));
                    
                    this.classList.remove('active');
                }, () => {
                    alert('Не удалось определить ваше местоположение');
                    this.classList.remove('active');
                });
            }
        });
        
        document.getElementById('info-btn').addEventListener('click', function() {
            var panel = document.getElementById('map-info-panel');
            panel.classList.toggle('show');
            this.classList.toggle('active');
        });
        
        document.getElementById('close-info').addEventListener('click', function() {
            document.getElementById('map-info-panel').classList.remove('show');
            document.getElementById('info-btn').classList.remove('active');
        });
        
        document.getElementById('route-btn').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    var userLat = position.coords.latitude;
                    var userLng = position.coords.longitude;
                    var url = `https://yandex.ru/maps/?rtext=${userLat},${userLng}~${lat},${lng}&rtt=auto`;
                    window.open(url, '_blank');
                }, () => {
                    openYandexMapsCoords(lat, lng);
                });
            } else {
                openYandexMapsCoords(lat, lng);
            }
        });
    }
    
    function updateCoordinateDisplay(lat, lng) {
        document.getElementById('coords-text').textContent = 
            `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
    
    function showCoordinateDisplay() {
        document.getElementById('coordinate-display').classList.add('show');
    }
    
    function hideCoordinateDisplay() {
        document.getElementById('coordinate-display').classList.remove('show');
    }
    
    function openYandexMaps(address) {
        var yandexUrl = 'https://yandex.ru/maps/?text=' + encodeURIComponent(address);
        window.open(yandexUrl, '_blank');
    }
    
    function openYandexMapsCoords(lat, lng) {
        var yandexUrl = `https://yandex.ru/maps/?ll=${lng},${lat}&z=17&pt=${lng},${lat}`;
        window.open(yandexUrl, '_blank');
    }
    
    function openGoogleMaps(lat, lng) {
        var googleUrl = `https://www.google.com/maps?q=${lat},${lng}&z=17`;
        window.open(googleUrl, '_blank');
    }
    
    function contactForm() {
        return {
            form: {
                name: '',
                phone: '',
                email: '',
                message: '',
                consent: false
            },
            loading: false,
            message: '',
            messageType: 'success',
            
            async submitForm() {
                if (!this.validateForm()) return;
                
                this.loading = true;
                this.message = '';
                
                try {
                    const formData = new FormData();
                    Object.keys(this.form).forEach(key => {
                        formData.append(key, this.form[key]);
                    });
                    
                    const response = await fetch('{% url "core:contacts" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    });
                    
                    if (response.ok) {
                        this.message = 'Спасибо! Ваша заявка отправлена. Мы свяжемся с вами в ближайшее время.';
                        this.messageType = 'success';
                        this.resetForm();
                    } else {
                        throw new Error('Ошибка отправки');
                    }
                } catch (error) {
                    this.message = 'Произошла ошибка при отправке заявки. Попробуйте позже или позвоните нам.';
                    this.messageType = 'error';
                } finally {
                    this.loading = false;
                }
            },
            
            validateForm() {
                if (!this.form.name.trim()) {
                    this.showError('Введите ваше имя');
                    return false;
                }
                if (!this.form.phone.trim()) {
                    this.showError('Введите номер телефона');
                    return false;
                }
                if (!this.form.consent) {
                    this.showError('Необходимо согласие на обработку персональных данных');
                    return false;
                }
                return true;
            },
            
            showError(text) {
                this.message = text;
                this.messageType = 'error';
            },
            
            resetForm() {
                this.form = {
                    name: '',
                    phone: '',
                    email: '',
                    message: '',
                    consent: false
                };
            }
        }
    }

    function formatPhone(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 0) {
            if (value[0] === '8') value = '7' + value.slice(1);
            if (value[0] !== '7') value = '7' + value;
        }
        
        let formatted = '';
        if (value.length > 0) {
            formatted = '+7';
            if (value.length > 1) formatted += ' (' + value.slice(1, 4);
            if (value.length > 4) formatted += ') ' + value.slice(4, 7);
            if (value.length > 7) formatted += '-' + value.slice(7, 9);
            if (value.length > 9) formatted += '-' + value.slice(9, 11);
        }
        
        input.value = formatted;
    }
</script>
{% endblock %}